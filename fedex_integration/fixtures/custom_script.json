[
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Packing Slip", 
  "modified": "2017-01-07 15:28:38.097071", 
  "name": "Packing Slip-Client", 
  "script": "cur_frm.add_fetch(\"delivery_note\", \"customer\", \"customer\");\ncur_frm.add_fetch(\"delivery_note\", \"customer_name\", \"customer_name\");\n\nfrappe.ui.form.on(\"Packing Slip\", \"shipping_address_name\", function(frm, cdt, cdn){\n\terpnext.utils.get_address_display(frm, 'shipping_address_name', 'shipping_address', true);\n})\n\nfrappe.ui.form.on(\"Packing Slip\", \"company_address_name\", function(frm, cdt, cdn){\n\terpnext.utils.get_address_display(frm, 'company_address_name', 'company_address', true);\n})\n\n\ncur_frm.set_query('company_address_name', function(){\n\treturn {\n\t\t\"filters\": {\n\t\t\t\"is_your_company_address\": 1\n\t\t}\n\t};\n});\n\n\ncur_frm.set_query('shipping_address_name', function(doc){\n\treturn {\n\t\t\"filters\": {\n\t\t\t\"customer\": doc.customer\n\t\t}\n\t};\n});\n\n\ncur_frm.set_query('weight_uom', 'items', function(doc, cdt, cdn) {\n  \tvar d  = locals[cdt][cdn];\n  \tvar filter_value = doc.is_fedex_account ? [\"in\", [\"LB\", \"Kg\"]] : [\"not in\", [\"\"]];\n  \treturn {\n  \t\tfilters:{\n  \t\t\t\"name\": filter_value\n  \t\t}\n  \t}\n});\n\nfrappe.ui.form.on('Packing Slip', {\n\tis_fedex_account: function(frm){\n\t\tcur_frm.cscript.enable_fedex_fields(frm);\t\n\t},\n\tshipment_forwarder:function(frm){\n\t\tif (frm.doc.shipment_forwarder == \"\"){\n\t\t\tcur_frm.set_value(\"is_fedex_account\", 0);\n\t\t}\n\t},\n\tshipping_payment_by:function(frm){\n\t\tfrm.toggle_reqd(\"shipping_payment_account\", inList([\"RECIPIENT\", \"THIRD_PARTY\"], frm.doc.shipping_payment_by));\n\t},\n\tduties_payment_by:function(frm){\n\t\tfrm.toggle_reqd(\"duties_payment_account\", inList([\"RECIPIENT\", \"THIRD_PARTY\"], frm.doc.duties_payment_by));\n\t},\n\tno_of_packages:function(frm){\n\t\tif(frm.doc.no_of_packages){\n\t\t\tvar package_array = new Array(frm.doc.no_of_packages)\n\t\t\tfrappe.call({\n\t\t\t\tmethod:\"frappe.client.get_list\",\n\t\t\t\targs:{\n\t\t\t\t\tdoctype:\"FedEx Package\",\n\t\t\t\t\tfields: [\"name\"],\n\t\t\t\t\torder_by: \"name asc\",\n\t\t\t\t\tlimit_page_length : frm.doc.no_of_packages\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tcur_frm.set_value(\"fedex_package_details\", []);\n\t\t\t\t\tcur_frm.set_value(\"item_packing_details\", []);\n\t\t\t\t\tif (r.message.length == frm.doc.no_of_packages){\n\t\t\t\t\t\t$.each(package_array, function(i, d) {\n\t\t\t\t\t\t\tvar row = frappe.model.add_child(frm.doc, \"FedEx Package Details\", \"fedex_package_details\");\n\t\t\t\t\t\t\trow.fedex_package = r.message[i].name;\n\t\t\t\t\t\t});\n\t\t\t\t\t\tcur_frm.refresh_field(\"fedex_package_details\");\n\t\t\t\t\t\tcur_frm.cscript.set_package_uom(frm);\n\t\t\t\t\t}else{\n\t\t\t\t\t\tfrappe.msgprint(__(repl(\"%(pkg_no)s Packages not found in FedEx Package master.\\\n\t\t\t\t\t\t\t\t\t\t\t\tPlease add packages in master & try again.\", {\"pkg_no\":frm.doc.no_of_packages})));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\t\n\t\t}\n\t},\n\trefresh:function(frm){\n\t\tif(frm.doc.is_fedex_account){\n\t\t\tif(frm.doc.docstatus == 1){\n\t\t\t\t$(frm.fields_dict.master_tracking_id.wrapper).html(\n\t\t\t\t\tfrappe.render_template(\"fedex_tracking\",{\"tracking_ids\":frm.doc.fedex_package_details}));\n\t\t\t\tif(!frm.doc.is_pickup_scheduled){\n\t\t\t\t\tcur_frm.add_custom_button(__('Schedule Pickup'),\n\t\t\t\t\t\tfunction() { cur_frm.cscript.schedule_pickup(); });\t\n\t\t\t\t}\n\t\t\t}\n\n\t\t}else{\n\t\t\t$(frm.fields_dict.master_tracking_id.wrapper).html(\"\");\n\t\t}\n\t\tcur_frm.cscript.enable_fedex_fields(frm);\n\n\t},\n\tset_kg:function(frm){\n\t\tif (frm.doc.set_kg){\n\t\t\tcur_frm.events.init_weight_uom_change_process(frm, \"Kg\", \"CM\", \"set_lb\");\n\t\t}\n\t},\n\tset_lb:function(frm){\n\t\tif (frm.doc.set_lb){\n\t\t\tcur_frm.events.init_weight_uom_change_process(frm, \"LB\", \"IN\", \"set_kg\");\n\t\t}\n\t},\n\tonload:function(frm){\n\t\tcur_frm.cscript.set_weight_uom_formatter();\n\t},\n\tinit_weight_uom_change_process:function(frm, wt_uom, pkg_uom, field){\n\t\tcur_frm.cscript.set_box_uom(frm, pkg_uom);\n\t\tcur_frm.cscript.set_item_weight_uom(wt_uom);\n\t\tcur_frm.set_value(field, 0);\n\t\tcur_frm.cscript.set_gross_wt_uom(frm, wt_uom);\n\t\tcur_frm.refresh_field(\"items\");\n\t}\n});\n\nget_entity_list = function(child_table, field_name){\n\tvar entity_ids = [];\n\t$.each(cur_frm.doc[child_table], function(i, pkg){\n\t\tentity_ids.push(pkg[field_name]);\n\t})\n\treturn entity_ids\n}\n\ncur_frm.cscript.schedule_pickup = function(){\n\tfrappe.prompt(\n\t\t\t[\n\t\t\t\t{fieldtype:'Datetime', fieldname:'ready_time', label: __('Package Ready Time'), 'reqd':1},\n\t\t\t],\n\t\t\tfunction(data){\n\t\t\t\tfrappe.call({\n\t\t\t\t\tfreeze:true,\n\t\t\t\t\tfreeze_message: __(\"Scheduling pickup.................\"),\n\t\t\t\t\tmethod:\"fedex_integration.fedex_integration.custom_packing_slip.custom_packing_slip.schedule_pickup\",\n\t\t\t\t\targs:{\"request_data\":{\"fedex_account\":cur_frm.doc.shipment_forwarder, \"gross_weight\":cur_frm.doc.gross_weight_pkg, \n\t\t\t\t\t\t\t\t\t\t\t\"uom\":cur_frm.doc.gross_weight_uom, \"package_count\":cur_frm.doc.no_of_packages,\n\t\t\t\t\t\t\t\t\t\t\t\"shipper_id\":cur_frm.doc.company_address_name, \"ready_time\":data.ready_time}},\n\t\t\t\t\tcallback:function(r){\n\t\t\t\t\tif(r.message.response == \"SUCCESS\"){\n\t\t\t\t\t\t\tcur_frm.set_value(\"is_pickup_scheduled\", true);\n\t\t\t\t\t\t\tcur_frm.set_value(\"pickup_no\", r.message.pickup_id);\n\t\t\t\t\t\t\tcur_frm.set_value(\"pickup_location\", r.message.location_no);\n\t\t\t\t\t\t\tcur_frm.save_or_update();\n\t\t\t\t\t\t\tfrappe.msgprint(__(\"Pickup service scheduled successfully.\"));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\t\t\t__(\"Schedule pickup ?\"), __(\"Yes\"));\n}\n\ncur_frm.cscript.convert_shipment_amount = function(frm){\n\tfrappe.call({\n\t\tmethod: \"erpnext.setup.utils.get_exchange_rate\",\n\t\targs: {\n\t\t\tfrom_currency: frm.doc.shipment_currency,\n\t\t\tto_currency: frm.doc.currency \n\t\t},\n\t\tcallback: function(r, rt) {\n\t\t\tcur_frm.set_value(\"base_shipment_amount\", flt(frm.doc.shipment_amount * r.message));\n\t\t}\n\t})\n\t\n}\n\ncur_frm.cscript.enable_fedex_fields = function(frm){\n\tvar fields = [\"drop_off_type\", \"service_type\", \"packaging_type\", \"total_handling_units\",\n\t\t\t\"shipping_payment_by\", \"duties_payment_by\", \"no_of_packages\", \"shipment_purpose\",\n\t\t\t\"shipment_type\", \"octroi_payment_by\"];\n\t$.each(fields, function(i, field){\n\t\tfrm.toggle_reqd(field, frm.doc.is_fedex_account);\t\n\t});\n\tfrm.toggle_enable(\"fedex_tracking_id\", !frm.doc.is_fedex_account);\n}\n\n\ncur_frm.set_query('weight_uom', 'items', function(doc, cdt, cdn) {\n\tvar d  = locals[cdt][cdn];\n\tvar filter_value = doc.is_fedex_account ? [\"in\", [\"LB\", \"Kg\"]] : [\"not in\", [\"\"]];\n\treturn {\n\t\tfilters:{\n\t\t\t\"name\": filter_value\n\t\t}\n\t}\n});\n\n\ncur_frm.set_query('fedex_package', 'item_packing_details', function(doc, cdt, cdn) {\n\tvar d  = locals[cdt][cdn];\n\tvar package_ids = get_entity_list(\"fedex_package_details\", \"fedex_package\");\n\treturn {\n\t\tquery:\"fedex_integration.fedex_integration.doctype.fedex_package.fedex_package.package_query\",\n\t\tfilters:{\n\t\t\t\"name\":package_ids\n\t\t}\n\t}\n});\n\ncur_frm.set_query('item_code', 'item_packing_details', function(doc, cdt, cdn) {\n\tvar d  = locals[cdt][cdn];\n\tvar items = get_entity_list(\"items\", \"item_code\");\n\treturn {\n\t\tfilters:{\n\t\t\t\"name\":[\"in\", items]\n\t\t}\n\t}\n});\n\nfrappe.ui.form.on(\"Packing Slip Item\", \"rate\", function(frm, cdt, cdn){\n\tvar row = locals[cdt][cdn];\n\tfrappe.model.set_value(row.doctype, row.name, \"amount\", flt(row.rate) * flt(row.qty));\n})\n\nfrappe.ui.form.on(\"Packing Slip Item\", \"qty\", function(frm, cdt, cdn){\n\tvar row = locals[cdt][cdn];\n\tfrappe.model.set_value(row.doctype, row.name, \"amount\", flt(row.rate) * flt(row.qty));\n\tfrappe.model.set_value(row.doctype, row.name, \"total_weight\", flt(row.net_weight) * flt(row.qty));\n\tcur_frm.cscript.set_total_handling_units(frm);\n\tcur_frm.cscript.calculate_total_pkg_wt(frm);\n})\n\ncur_frm.cscript.get_items = function(doc, cdt, cdn) {\n\tthis.frm.call({\n\t\tdoc: this.frm.doc,\n\t\tmethod: \"get_items\",\n\t\tcallback: function(r) {\n\t\t\tif(!r.exc){\n\t\t\t\tcur_frm.set_value(\"fedex_package_details\", []);\n\t\t\t\tcur_frm.set_value(\"item_packing_details\", []);\n\t\t\t\tcur_frm.set_value(\"no_of_packages\", \"\");\n\t\t\t\tcur_frm.cscript.set_total_handling_units(cur_frm);\n\t\t\t\tcur_frm.cscript.calculate_total_pkg_wt(cur_frm);\n\t\t\t\tcur_frm.refresh_fields();\n\t\t\t}\n\t\t}\n\t});\n}\n\nfrappe.ui.form.on(\"FedEx Notification\",{\n\tselect_all:function(frm ,cdt,cdn){\n\t\tvar row = locals[cdt][cdn];\n\t\t$.each([\"shipment\", \"tendered\", \"exception\", \"delivery\"], function(index, field) {\n\t\t\tfrappe.model.set_value(row.doctype, row.name, field, row.select_all);\n\t\t})\n\t}\n})\n\ncur_frm.cscript.set_box_uom = function(frm, uom){\n\t$.each(frm.doc.fedex_package_details || [], function(i, row) {\n\t\tfrappe.model.set_value(row.doctype, row.name, \"unit\", uom || \"\");\n\t});\n}\n\nfrappe.ui.form.on(\"FedEx Notification\",{\n\tselect_all:function(frm ,cdt,cdn){\n\t\tvar row = locals[cdt][cdn];\n\t\t$.each([\"shipment\", \"tendered\", \"exception\", \"delivery\"], function(index, field) {\n\t\t\tfrappe.model.set_value(row.doctype, row.name, field, row.select_all);\n\t\t})\n\t}\n})\n\nfrappe.ui.form.on(\"Packing Slip Item\", \"net_weight\", function(frm, cdt, cdn){\n\tvar row = locals[cdt][cdn];\n\tfrappe.model.set_value(row.doctype, row.name, \"total_weight\", flt(row.net_weight) * flt(row.qty));\n\tcur_frm.cscript.calculate_total_pkg_wt(frm);\n})\n\ncur_frm.cscript.set_item_weight_uom = function(uom){\n\t$.each(cur_frm.doc.items || [], function(i, row) {\n\t\tfrappe.model.set_value(row.doctype, row.name, \"weight_uom\", uom);\n\t});\n}\n\ncur_frm.cscript.set_package_uom = function(frm){\n\tvar pkg_uom = \"\";\n\tif(frm.doc.set_kg){\n\t\tpkg_uom = \"CM\";\n\t}else if(frm.doc.set_lb){\n\t\tpkg_uom = \"IN\";\n\t}\n\tcur_frm.cscript.set_box_uom(frm, pkg_uom);\n}\n\ncur_frm.cscript.set_total_handling_units = function(frm){\n\tvar total_qty = 0;\n\t$.each(frm.doc.items || [], function(i, row) {\n\t\ttotal_qty += row.qty;\n\t});\n\tcur_frm.set_value(\"total_handling_units\", total_qty);\t\n}\n\n\nfrappe.ui.form.on(\"Packing Slip Item\", \"items_remove\", function(frm) {\n\tcur_frm.cscript.set_total_handling_units(frm);\n\tcur_frm.cscript.calculate_total_pkg_wt(frm);\n});\n\ncur_frm.cscript.calculate_total_pkg_wt = function(frm){\n\tvar ps_detail = frm.doc.items || [];\n\tcur_frm.cscript.calc_net_total_pkg(frm.doc, ps_detail);\n}\n\n\n// Calculate Net Weight of Package according to clients requirement\ncur_frm.cscript.calc_net_total_pkg = function(doc, ps_detail) {\n\tvar net_weight_pkg = 0;\n\tdoc.net_weight_uom = (ps_detail && ps_detail.length) ? ps_detail[0].weight_uom : '';\n\tdoc.gross_weight_uom = doc.net_weight_uom;\n\n\tfor(var i=0; i<ps_detail.length; i++) {\n\t\tvar item = ps_detail[i];\n\t\tif(item.weight_uom != doc.net_weight_uom) {\n\t\t\tmsgprint(__(\"Different UOM for items will lead to incorrect (Total) Net Weight value. Make sure that Net Weight of each item is in the same UOM.\"));\n\t\t\tvalidated = false;\n\t\t}\n\t\tnet_weight_pkg += flt(item.total_weight);\n\t}\n\n\tdoc.net_weight_pkg = _round(net_weight_pkg, 2);\n\tdoc.gross_weight_pkg = doc.net_weight_pkg\n\trefresh_many(['net_weight_pkg', 'net_weight_uom', 'gross_weight_uom', 'gross_weight_pkg']);\n}\n\n\ncur_frm.cscript.set_gross_wt_uom = function(frm, uom){\n\tfrm.doc.gross_weight_uom = uom;\n\tfrm.doc.net_weight_uom = uom;\n\trefresh_many(['net_weight_uom', 'gross_weight_uom']);\n}\n\ncur_frm.cscript.change_grid_labels = function(label, wt_uom){\n\tvar df = frappe.meta.get_docfield(\"Packing Slip Item\", \"net_weight\", cur_frm.doc.name);\n\tif(df) df.label = label;\n\tcur_frm.refresh_fields();\n}\n\nfrappe.ui.form.on(\"Packing Slip Item\", \"total_weight\", function(frm, cdt, cdn){\n\tcur_frm.cscript.calculate_total_pkg_wt(frm);\n})\n\ncur_frm.cscript.set_weight_uom_formatter = function(){\n\t$.each([\"net_weight\", \"total_weight\"], function(i, field){\n\t\tvar df = frappe.meta.get_docfield(\"Packing Slip Item\", field, cur_frm.doc.name);\n\t\tdf.formatter = function(value, df, options, doc) {\n\t\t\tvar uom = doc.weight_uom ? doc.weight_uom : \"\"\n\t\t\treturn frappe.form.formatters._right( (value==null || value===\"\") ? \"\" : value + \"  \" + uom , options)\n\t\t}\n\t});\n}", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Sales Order", 
  "modified": "2017-01-07 14:29:30.954668", 
  "name": "Sales Order-Client", 
  "script": "cur_frm.add_fetch(\"item_code\", \"country_of_manufacture\", \"country_of_manufacture\");\ncur_frm.add_fetch(\"item_code\", \"country_code\", \"country_code\");", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Delivery Note", 
  "modified": "2017-01-07 14:29:17.521202", 
  "name": "Delivery Note-Client", 
  "script": "cur_frm.add_fetch(\"item_code\", \"country_of_manufacture\", \"country_of_manufacture\");\ncur_frm.add_fetch(\"item_code\", \"country_code\", \"country_code\");", 
  "script_type": "Client"
 }
]